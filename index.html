<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Sean's Surf Report</title>

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="/img/favicon.png">

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-1.10.2.min.js" defer></script>
    <script type="module" src="./components/logo-header.js" defer></script>
    <script type="module" src="./components/nav-location-card.js" defer></script>
    <script type="module" src="./components/top-navigation.js" defer></script>
    <script type="module" src="./components/location-card.js" defer></script>
    <script type="module" src="./components/page-hit-counter.js" defer></script>
    <script type="module" src="./components/footer-pagecount.js" defer></script>
</head>

<body>
    <logo-header></logo-header>
    <main>
        <div class="album py-4 bg-body-tertiary">
            <div class="container">
                <div id="cards-grid" class="row row-cols-1 row-cols-lg-2 g-4 g-sm-6">
                    <!-- Location Cards -->
                    <!-- KBC -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/kbc"
                            title="Kitesurf Beach Center, UAQ" link-url="/kbc.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <div style="max-width: 200px">
                                <script id="wglive_2146_1706848056699" data-wg-spot="2146" defer></script>
                                <div class="wg-error" style="display: none; color: #dc3545;">Weather data unavailable
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Blue Ocean Sports -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/bos"
                            title="Blue Ocean Sports, Jebel Ali" link-url="/blue-ocean-sports.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <div style="max-width: 200px">
                                <script id="wglive_3568_1706847920748" data-wg-spot="3568" defer></script>
                                <div class="wg-error" style="display: none; color: #dc3545;">Weather data unavailable
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Yas Kite Beach -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/yas"
                            title="Yas Kite Area, Abu Dhabi" link-url="/yas.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <div style="max-width: 200px">
                                <script id="wglive_3858_1710779222995" data-wg-spot="3858" defer></script>
                                <div class="wg-error" style="display: none; color: #dc3545;">Weather data unavailable
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Dubai Offshore Sailing Club -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/dosc"
                            title="Dubai Offshore Sailing Club" link-url="/dosc.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <div style="max-width: 200px">
                                <script id="wglive_4065_1715855101032" data-wg-spot="4065" defer></script>
                                <div class="wg-error" style="display: none; color: #dc3545;">Weather data unavailable
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Sandy Beach Hotel -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/sandy"
                            title="Sandy Beach Hotel, Dibba" link-url="/sandy.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <div style="max-width: 200px">
                                <script id="wglive_2014_1713422960240" data-wg-spot="2014" defer></script>
                                <div class="wg-error" style="display: none; color: #dc3545;">Weather data unavailable
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Mikoko -->
                    <div class="col position-relative">
                        <location-card image-url="https://worker.seanssurfreport.workers.dev/mikoko"
                            title="Mikoko, Umm Al Quwain" link-url="/mikoko.html" hide-refresh="true">
                        </location-card>
                        <div class="widget position-absolute">
                            <!-- Placeholder for widget -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer-pagecount></footer-pagecount>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe" crossorigin="anonymous"
        defer></script>
    <script>
        // Consolidated Windguru widget loader with error handling
        document.addEventListener('DOMContentLoaded', () => {
            const wgConfig = {
                color: 'light',
                wj: 'knots',
                tj: 'c',
                avg_min: '0',
                gsize: '400',
                msize: '400',
                m: '3',
                arrow: 'y',
                show: 'n,g,c,f,m'
            };

            const loadWindguruWidget = (script) => {
                const spotId = script.getAttribute('data-wg-spot');
                const uid = script.id;
                const errorDiv = script.nextElementSibling;
                const params = [`spot=${spotId}`, `uid=${uid}`, ...Object.entries(wgConfig).map(([k, v]) => `${k}=${v}`)];
                const wgScript = document.createElement('script');

                wgScript.src = `https://www.windguru.cz/js/wglive.php?${params.join('&')}`;
                wgScript.async = true;

                wgScript.onerror = () => {
                    console.error(`Failed to load Windguru widget for spot ${spotId}`);
                    if (errorDiv && errorDiv.classList.contains('wg-error')) {
                        errorDiv.style.display = 'block';
                    }
                };

                wgScript.onload = () => {
                    if (errorDiv && errorDiv.classList.contains('wg-error')) {
                        errorDiv.style.display = 'none';
                    }
                };

                script.parentNode.insertBefore(wgScript, script.nextSibling);
            };

            document.querySelectorAll('script[id^="wglive_"]').forEach(script => {
                try {
                    loadWindguruWidget(script);
                } catch (error) {
                    console.error('Error initializing Windguru widget:', error);
                    const errorDiv = script.nextElementSibling;
                    if (errorDiv && errorDiv.classList.contains('wg-error')) {
                        errorDiv.style.display = 'block';
                    }
                }
            });
        });

        // Discourse notification bubble logic
        document.addEventListener('DOMContentLoaded', () => {
            const logoHeader = document.querySelector('logo-header');
            const bubble = logoHeader.shadowRoot.querySelector('.notification-bubble');
            const forumUrl = 'https://community.seanssurfreport.com';
            const apiEndpoint = `${forumUrl}/latest.json`;

            async function checkForNewPosts() {
                try {
                    const response = await fetch(apiEndpoint, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                    });
                    const data = await response.json();

                    const lastVisit = localStorage.getItem('lastVisit') || Date.now();
                    const lastVisitTime = new Date(parseInt(lastVisit));

                    const newPosts = data.topics.filter(topic => {
                        const topicCreatedAt = new Date(topic.created_at);
                        return topicCreatedAt > lastVisitTime;
                    });

                    if (newPosts.length > 0 && bubble) {
                        bubble.classList.add('active');
                    } else if (bubble) {
                        bubble.classList.remove('active');
                    }

                    const communityLink = logoHeader.shadowRoot.querySelector('.main-nav-link');
                    if (communityLink) {
                        communityLink.addEventListener('click', () => {
                            localStorage.setItem('lastVisit', Date.now());
                            if (bubble) bubble.classList.remove('active');
                        });
                    }
                } catch (error) {
                    console.error('Error fetching Discourse posts:', error);
                }
            }

            checkForNewPosts();
            setInterval(checkForNewPosts, 300000); // Check every 5 minutes
        });
    </script>
</body>

</html>